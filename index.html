<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Terror en el Bosque 3.0</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        #instrucciones {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; text-align: center; background: rgba(0,0,0,0.9);
            padding: 30px; border: 2px solid red; z-index: 100; cursor: pointer;
        }
        #ui { position: absolute; bottom: 20px; left: 20px; color: #ff0000; font-size: 18px; text-shadow: 2px 2px #000; }
        #gameover { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: red; color: black; display: none; 
            justify-content: center; align-items: center; font-size: 50px; flex-direction: column; z-index: 200;
        }
    </style>
</head>
<body>

<div id="instrucciones">
    <h1>PERDIDO EN EL BOSQUE</h1>
    <p>HAZ CLIC PARA EMPEZAR</p>
    <p>WASD: Mover | CTRL: Agacharse | E: Armario</p>
</div>

<div id="gameover">
    <h1>EL MONSTRUO TE COMIÓ</h1>
    <button onclick="location.reload()" style="padding:10px 20px; cursor:pointer">REINTENTAR</button>
</div>

<div id="ui">BUSCA EL ARMARIO PARA SOBREVIVIR</div>

<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

    // --- ESCENA Y CONFIGURACIÓN ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.12); // Niebla cerrada

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // --- ILUMINACIÓN (LINTERNA) ---
    const flashlight = new THREE.SpotLight(0xffffff, 2);
    flashlight.angle = Math.PI / 7;
    flashlight.decay = 2;
    flashlight.distance = 25;
    camera.add(flashlight);
    flashlight.target.position.set(0, 0, -1);
    camera.add(flashlight.target);
    scene.add(camera);

    // --- EL BOSQUE (ESTRUCTURA) ---
    // Suelo
    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(200, 200),
        new THREE.MeshStandardMaterial({ color: 0x0a1a0a })
    );
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    // Generar Árboles
    const treeTrunkGeo = new THREE.CylinderGeometry(0.3, 0.5, 10);
    const treeTrunkMat = new THREE.MeshStandardMaterial({ color: 0x221100 });
    const treeLeavesGeo = new THREE.ConeGeometry(2, 6, 8);
    const treeLeavesMat = new THREE.MeshStandardMaterial({ color: 0x051105 });

    for(let i = 0; i < 150; i++) {
        const x = Math.random() * 100 - 50;
        const z = Math.random() * 100 - 50;
        if (Math.abs(x) < 3 && Math.abs(z) < 3) continue; // No poner árboles encima del spawn

        const trunk = new THREE.Mesh(treeTrunkGeo, treeTrunkMat);
        trunk.position.set(x, 5, z);
        scene.add(trunk);

        const leaves = new THREE.Mesh(treeLeavesGeo, treeLeavesMat);
        leaves.position.set(x, 10, z);
        scene.add(leaves);
    }

    // --- ARMARIO (REFUGIO) ---
    const closet = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 1.5), new THREE.MeshStandardMaterial({ color: 0x3d2000 }));
    const doorLeft = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3.8, 1.4), new THREE.MeshStandardMaterial({ color: 0x1a0f00 }));
    doorLeft.position.set(0.9, 0, 0);
    closet.add(body, doorLeft);
    closet.position.set(0, 2, -15); // Ubicado al frente del inicio
    scene.add(closet);

    // --- MONSTRUO ---
    const monster = new THREE.Mesh(
        new THREE.BoxGeometry(1, 4, 1),
        new THREE.MeshBasicMaterial({ color: 0x000000 }) // Negro total para que sea una sombra
    );
    // Le ponemos ojos rojos brillantes
    const eye1 = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({color: 0xff0000}));
    eye1.position.set(0.2, 1.5, 0.5);
    const eye2 = eye1.clone();
    eye2.position.set(-0.2, 1.5, 0.5);
    monster.add(eye1, eye2);
    monster.position.set(30, 2, 30);
    scene.add(monster);

    // --- LÓGICA DE JUEGO ---
    let keys = {};
    let isCrouching = false;
    let isHidden = false;
    let gameOver = false;
    let yaw = 0, pitch = 0;

    document.addEventListener('keydown', (e) => {
        keys[e.code] = true;
        if(e.code === 'KeyE') tryHide();
    });
    document.addEventListener('keyup', (e) => keys[e.code] = false);

    function tryHide() {
        const dist = camera.position.distanceTo(closet.position);
        if(dist < 3) {
            isHidden = !isHidden;
            if(isHidden) {
                camera.position.set(closet.position.x, 1.7, closet.position.z);
            }
        }
    }

    const ins = document.getElementById('instrucciones');
    ins.addEventListener('click', () => document.body.requestPointerLock());

    document.addEventListener('mousemove', (e) => {
        if(document.pointerLockElement && !isHidden) {
            yaw -= e.movementX * 0.002;
            pitch -= e.movementY * 0.002;
            pitch = Math.max(-1.5, Math.min(1.5, pitch));
            camera.rotation.set(pitch, yaw, 0, 'YXZ');
        }
    });

    function update() {
        if(gameOver) return;
        requestAnimationFrame(update);

        if(document.pointerLockElement) {
            if(!isHidden) {
                // Movimiento y Agachado
                isCrouching = keys['ControlLeft'];
                camera.position.y += ((isCrouching ? 0.8 : 1.7) - camera.position.y) * 0.1;
                
                let speed = isCrouching ? 0.04 : 0.1;
                let move = new THREE.Vector3();
                if(keys['KeyW']) move.z -= 1;
                if(keys['KeyS']) move.z += 1;
                if(keys['KeyA']) move.x -= 1;
                if(keys['KeyD']) move.x += 1;
                move.applyQuaternion(camera.quaternion);
                move.y = 0;
                camera.position.add(move.multiplyScalar(speed));

                // IA del Monstruo
                const dist = monster.position.distanceTo(camera.position);
                // Si corres (no estas agachado), te oye desde más lejos
                const detectionRange = isCrouching ? 10 : 25;
                
                if(dist < detectionRange) {
                    const dir = new THREE.Vector3().subVectors(camera.position, monster.position).normalize();
                    monster.position.add(dir.multiplyScalar(0.06)); // Velocidad del monstruo
                    monster.lookAt(camera.position.x, 2, camera.position.z);
                }

                // COLISIÓN DE MUERTE
                if(dist < 1.5) {
                    gameOver = true;
                    document.exitPointerLock();
                    document.getElementById('gameover').style.display = 'flex';
                }

                document.getElementById('ui').innerText = "ESTADO: EXPLORANDO EL BOSQUE";
            } else {
                document.getElementById('ui').innerText = "ESTADO: ESCONDIDO EN ARMARIO (Pulsa E para salir)";
                // El monstruo se aleja si estás escondido
                monster.position.x += 0.02; 
            }
        }
        renderer.render(scene, camera);
    }

    camera.position.set(0, 1.7, 5);
    update();
</script>
</body>
</html>
