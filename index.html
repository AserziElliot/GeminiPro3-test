<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test 3D Terror</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #222; font-family: sans-serif; }
        #instrucciones {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; text-align: center; background: rgba(0,0,0,0.9);
            padding: 30px; border: 3px solid #ff0000; z-index: 10; cursor: pointer;
        }
        #ui { position: absolute; bottom: 10px; left: 10px; color: yellow; font-size: 20px; }
    </style>
</head>
<body>

<div id="instrucciones">
    <h1>ESTADO DE PRUEBA 3D</h1>
    <p>SI VES ESTE CUADRO, HAZ CLIC PARA ENTRAR</p>
    <p>Mover: WASD | Agacharse: CTRL | Mirar: RATÓN</p>
</div>
<div id="ui">Esperando inicio...</div>

<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111); // Fondo gris oscuro, no negro total

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // --- LUCES PARA VER TODO ---
    const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0); // Luz global fuerte
    scene.add(light);

    const pointLight = new THREE.PointLight(0xffffff, 1);
    camera.add(pointLight); // La cámara lleva una luz incorporada
    scene.add(camera);

    // --- OBJETOS VISIBLES ---
    // Suelo cuadriculado para notar el movimiento
    const grid = new THREE.GridHelper(100, 50, 0xff0000, 0x444444);
    scene.add(grid);

    // El Armario (Cubo Marrón)
    const armario = new THREE.Mesh(
        new THREE.BoxGeometry(2, 4, 1),
        new THREE.MeshStandardMaterial({ color: 0x552200 })
    );
    armario.position.set(0, 2, -10);
    scene.add(armario);

    // El Monstruo (Cubo Rojo Brillante)
    const monstruo = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 4, 1.5),
        new THREE.MeshBasicMaterial({ color: 0xff0000 })
    );
    monstruo.position.set(10, 2, -15);
    scene.add(monstruo);

    // --- CONTROLES ---
    let keys = {};
    let isCrouching = false;
    let yaw = 0, pitch = 0;

    document.addEventListener('keydown', (e) => keys[e.code] = true);
    document.addEventListener('keyup', (e) => keys[e.code] = false);

    const ins = document.getElementById('instrucciones');
    ins.addEventListener('click', () => {
        document.body.requestPointerLock();
    });

    document.addEventListener('pointerlockchange', () => {
        ins.style.display = document.pointerLockElement ? 'none' : 'block';
    });

    document.addEventListener('mousemove', (e) => {
        if(document.pointerLockElement) {
            yaw -= e.movementX * 0.002;
            pitch -= e.movementY * 0.002;
            pitch = Math.max(-1.5, Math.min(1.5, pitch));
            camera.rotation.set(pitch, yaw, 0, 'YXZ');
        }
    });

    // --- BUCLE PRINCIPAL ---
    function update() {
        requestAnimationFrame(update);
        
        if(document.pointerLockElement) {
            // Lógica de agachado
            isCrouching = keys['ControlLeft'];
            let targetH = isCrouching ? 0.8 : 1.8;
            camera.position.y += (targetH - camera.position.y) * 0.1;

            // Movimiento
            let speed = isCrouching ? 0.05 : 0.12;
            let move = new THREE.Vector3();
            if(keys['KeyW']) move.z -= 1;
            if(keys['KeyS']) move.z += 1;
            if(keys['KeyA']) move.x -= 1;
            if(keys['KeyD']) move.x += 1;

            move.applyQuaternion(camera.quaternion);
            move.y = 0;
            camera.position.add(move.multiplyScalar(speed));

            // El monstruo te busca
            let dist = monstruo.position.distanceTo(camera.position);
            if(dist > 2) {
                let dir = new THREE.Vector3().subVectors(camera.position, monstruo.position).normalize();
                monstruo.position.add(dir.multiplyScalar(0.03));
            }
            
            document.getElementById('ui').innerText = isCrouching ? "ESTADO: AGACHADO (Sigilo)" : "ESTADO: CAMINANDO";
        }
        renderer.render(scene, camera);
    }

    camera.position.set(0, 1.8, 5);
    update();

</script>
</body>
</html>
